@if (this.store.isLoaded()) {
<div
  class="z-30 overscroll-none scrollbar-hide font-tektur flex min-h-[100dvh] flex-col gap-4 pb-24 pt-[env(safe-area-inset-top,0px)] sm:gap-6 sm:pb-12 xl:gap-0 xl:pb-0"
>
  <app-game-header
    (openPrestige)="toggleModal('prestige', true)"
    (openProfile)="toggleModal('profile', true)"
    [session]="this.store.session()"
    [neededXp]="this.store.neededXp()"
  ></app-game-header>
  <div
    class="!z-max flex w-full flex-col gap-4 px-4 sm:px-6 xl:flex-1 xl:flex-row xl:items-end xl:justify-between xl:gap-0 xl:px-0"
  >
    <div class="fixed bottom-20 w-auto">
      <button
        (click)="toggleMobileUpgrades(true)"
        type="button"
        class="relative z-max mt-4 w-full xl:hidden"
      >
        <div
          class="flex items-center justify-center gap-2 rounded-3xl border-2 border-black bg-secondary px-4 py-3 text-lg font-bold text-black shadow-[0_6px_0_rgba(0,0,0,0.15)] transition-transform active:scale-95"
        >
          <img class="h-6 w-6" src="/icons/menu/up.svg" />
          Улучшения @if (store.hasUpgradeToBuy()) {
          <span
            class="bg-red-600 text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center border-2 border-black animate-pulse"
          >
            !
          </span>
          }
        </div>

        <div
          class="absolute -top-2 -right-2 bg-red-600 text-white text-xs font-bold px-2 py-0.5 rounded-full border-2 border-black pointer-events-none"
        >
          NEW
        </div>
      </button>

      <app-game-buttons
        (cook)="handleCook()"
        (sell)="handleSell()"
        [canCook]="this.store.canCook()"
        [canSell]="this.store.canSell()"
        [level]="this.store.session()?.level?.rank ?? 0"
      ></app-game-buttons>
    </div>
    <div class="hidden w-full xl:block xl:w-auto">
      <app-menu></app-menu>
    </div>
  </div>
</div>

<div [ngSwitch]="locationConfig.component">
  <app-track *ngSwitchCase="'track'" [decorCount]="4"></app-track>
  <app-cafe *ngSwitchCase="'cafe'"></app-cafe>
  <app-restaurant *ngSwitchCase="'restaurant'"></app-restaurant>
  <app-gastro-restaurant *ngSwitchCase="'gastro'"></app-gastro-restaurant>
  <app-final *ngSwitchCase="'final'"></app-final>
</div>

<img
  *ngIf="locationConfig.imgSrc"
  [ngClass]="locationConfig.imgClass"
  [src]="locationConfig.imgSrc"
  class="fixed bottom-[5dvh] left-[10dvw] z-max hidden xl:block"
/>

<app-modal
  (close)="toggleModal('profile', false)"
  [background]="'bg-secondary'"
  [border_color]="'brand'"
  [border_size]="16"
  [closeOnBackdrop]="true"
  [show]="profileWindowToggle"
>
  <app-profile (logoutEvent)="toggleModal('logout', $event)"></app-profile>
</app-modal>

<app-modal
  (close)="toggleModal('logout', false)"
  [background]="'bg-secondary'"
  [border_color]="'brand'"
  [border_size]="16"
  [closeOnBackdrop]="true"
  [show]="logoutWindowToggle"
>
  <div
    class="flex flex-col items-center font-tektur py-[3.5dvh] px-[8.5dvw] drop-shadow-md"
  >
    <h2 class="text-text text-center md:text-4xl">
      Вы уверены, <br />что хотите выйти?
    </h2>
    <section class="flex flex-row justify-center gap-4 w-full">
      <button
        (click)="logout()"
        class="bg-brand border-2 border-black mt-[2.5dvh] rounded-2xl px-6 py-3 font-bold text-2xl text-text w-full sm:w-auto"
      >
        Да
      </button>
      <button
        (click)="toggleModal('logout', false)"
        class="bg-brand border-2 border-black mt-[2.5dvh] rounded-2xl px-6 py-3 font-bold text-2xl text-text w-full sm:w-auto"
      >
        Нет
      </button>
    </section>
  </div>
</app-modal>

<app-prestige-window
  (closeEvent)="toggleModal('prestige', $event)"
  [enabled]="prestigeWindowToggle"
></app-prestige-window>

<div class="fixed z-max sound-control">
  <button
    #soundButton
    (click)="toggleVolumeSlider()"
    class="sound-btn border-2 border-black rounded-full bg-secondary shadow-[0_6px_0_rgba(0,0,0,0.15)] active:scale-95 transition"
    type="button"
  >
    <img
      [src]="
        sound.currentVolume > 0
          ? '/icons/game/sound-on.svg'
          : '/icons/game/sound-off.svg'
      "
      alt="Звук"
      class="w-7 h-7"
    />
  </button>

  <div
    *ngIf="showVolumeSlider"
    [ngClass]="{
      'animate-fade-in': !isClosingVolumeSlider,
      'animate-fade-out': isClosingVolumeSlider
    }"
    class="volume-slider-popover"
  >
    <input
      (input)="onVolumeChange($event); resetVolumeCloseTimer()"
      (pointerdown)="resetVolumeCloseTimer()"
      (pointerup)="resetVolumeCloseTimer()"
      [value]="sound.currentVolume"
      class="volume-slider"
      max="100"
      min="0"
      type="range"
    />
  </div>
</div>

<div
  *ngIf="showMobileUpgrades"
  class="fixed inset-0 z-max flex flex-col bg-black/60 backdrop-blur-sm xl:hidden"
>
  <button
    (click)="toggleMobileUpgrades(false)"
    aria-label="Закрыть меню улучшений"
    class="flex-1"
    type="button"
  ></button>
  <div class="mt-auto w-full px-4 pb-6">
    <app-menu
      (close)="toggleMobileUpgrades(false)"
      [showCloseButton]="true"
    ></app-menu>
  </div>
</div>
} @else {
<app-loading></app-loading>
}
